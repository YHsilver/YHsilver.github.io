<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Build a Mini Docker | Asher Yan's Blog</title><meta name="keywords" content="docker,go,linux"><meta name="author" content="Asher Yan"><meta name="copyright" content="Asher Yan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="In this post, we are going to build a mini docker with minimum codes but full functions.">
<meta property="og:type" content="article">
<meta property="og:title" content="Build a Mini Docker">
<meta property="og:url" content="https://blog.ashery.cn/posts/6cc923ae.html">
<meta property="og:site_name" content="Asher Yan&#39;s Blog">
<meta property="og:description" content="In this post, we are going to build a mini docker with minimum codes but full functions.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://images.ashery.cn/img/639debd8b1fccdcd36fe1b3d.jpg">
<meta property="article:published_time" content="2022-12-15T13:14:09.000Z">
<meta property="article:modified_time" content="2023-04-19T16:38:10.347Z">
<meta property="article:author" content="Asher Yan">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="go">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://images.ashery.cn/img/639debd8b1fccdcd36fe1b3d.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.ashery.cn/posts/6cc923ae"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Asher Yan","link":"链接: ","source":"来源: Asher Yan's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Build a Mini Docker',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-20 00:38:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script data-pace-options='{ "ajax":true, "document":true, "eventLag":true  }' src="https://cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/CodeByZach/pace@1.2.4/themes/blue/pace-theme-minimal.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://images.ashery.cn/img/202304202309024.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http://images.ashery.cn/img/639debd8b1fccdcd36fe1b3d.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Asher Yan's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Build a Mini Docker</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-12-15T13:14:09.000Z" title="发表于 2022-12-15 21:14:09">2022-12-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-19T16:38:10.347Z" title="更新于 2023-04-20 00:38:10">2023-04-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>19分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Build a Mini Docker"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>This post mainly refers to a “GOTO; Conferences” YouTube video “<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?app=desktop&v=8fi7uSYlOdc&feature=youtu.be">Learn how to code a container using Go code • Liz Rice</a>“. </p>
<p>She build a mini docker step by step with less than 100 lines codes, using the <code>Namespace</code> and <code>CGroups</code> provided by OS Kernel. It is not difficult to understand the main concept of the Container, as if you don’t dig into the details and have some basic knowledge to the Linux OS. And this video explains what the Docker really is one the other side, which confused me since I first saw the word Docker.</p>
<p>Talk is cheap, show me the code. Let’s start.</p>
<h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>We’ll build a ‘mini-docker’ that receive and execute a raw shell command for example.</p>
<blockquote>
<p>hint:  You must run this code in a Linux-Like OS</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a docker command and a mini-docker command that we defined</span></span><br><span class="line"></span><br><span class="line">docker		run	image	&lt;cmd&gt;	&lt;args&gt;</span><br><span class="line">go run main.go	run		&lt;cmd&gt;	&lt;args&gt;</span><br></pre></td></tr></table></figure>

<p>It’s easy to write the <code>main.go</code> as bellow:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// go run main.go run &lt;cmd&gt; &lt;args&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> os.Args[<span class="number">1</span>] &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;run&quot;</span>:</span><br><span class="line">		run()</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		fmt.Printf(<span class="string">&quot;do nothing, exit!!!&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Running %v\n&quot;</span>, os.Args[<span class="number">2</span>:])</span><br><span class="line">	cmd := exec.Command(os.Args[<span class="number">2</span>], os.Args[<span class="number">3</span>:]...)</span><br><span class="line">	cmd.Stdin = os.Stdin</span><br><span class="line">	cmd.Stdout = os.Stdout</span><br><span class="line">	cmd.Stderr = os.Stderr</span><br><span class="line"></span><br><span class="line">	cmd.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And the result is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bytedance@C02D83XAML85 [17:23:06] [~/myhub/containers-from-scratch] [master *]</span><br><span class="line">-&gt; % <span class="built_in">ls</span></span><br><span class="line">LICENSE   README.md main.go</span><br><span class="line"></span><br><span class="line">bytedance@C02D83XAML85 [17:23:06] [~/myhub/containers-from-scratch] [master *]</span><br><span class="line">-&gt; % go run main.go run <span class="built_in">ls</span> -l                    </span><br><span class="line">Running [<span class="built_in">ls</span> -l]</span><br><span class="line">total 24</span><br><span class="line">-rw-r--r--  1 bytedance  staff  1065 12 16 16:23 LICENSE</span><br><span class="line">-rw-r--r--  1 bytedance  staff   568 12 16 16:23 README.md</span><br><span class="line">-rw-r--r--  1 bytedance  staff   380 12 16 17:20 main.go</span><br></pre></td></tr></table></figure>

<p>It’s simplely execute a cmd on the host machine and the current process, what we really want is that the cmd <strong>execute in a seperate environment from the host</strong> current process. In order to achieve that, we need two feature provided by Operating System. In the Linux case, they are Namespaces and CGroups.</p>
<h1 id="Namespace-Visibility"><a href="#Namespace-Visibility" class="headerlink" title="Namespace: Visibility"></a>Namespace: Visibility</h1><p>Firstly, let’s get some basic prior knowledge of the <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/namespaces.7.html">Namespace</a> in the Linux OS. </p>
<p>Namepace provided by the Linux kernel can isolate a process  into a seperate environment. Changes to the global resource in a namespace are visible to other processes that are members of the namespace, but are invisible to other processes. </p>
<p>There are some types of namespace that seperate different resources.</p>
<table>
<thead>
<tr>
<th>Namespace</th>
<th>Flag</th>
<th>Kernel Version</th>
<th>Isolates</th>
</tr>
</thead>
<tbody><tr>
<td>UTS (Unix Time-sharing System)</td>
<td>CLONE_NEWUTS</td>
<td>Linux 2.4.19</td>
<td>Hostname and NIS domain name</td>
</tr>
<tr>
<td>IPC (Inter-Process Communication)</td>
<td>CLONE_NEWIPC</td>
<td>Linux 2.6.19</td>
<td>System V IPC, POSIX message queues</td>
</tr>
<tr>
<td>PID (Process ID)</td>
<td>CLONE_NEWPID</td>
<td>Linux 2.6.19</td>
<td>Process IDs</td>
</tr>
<tr>
<td>Network</td>
<td>CLONE_NEWNET</td>
<td>Linux 2.6.24</td>
<td>Network devices, stacks, ports, etc.</td>
</tr>
<tr>
<td>Mount</td>
<td>CLONE_NEWNS</td>
<td>Linux 2.6.29</td>
<td>Mount points</td>
</tr>
<tr>
<td>User</td>
<td>CLONE_NEWUSER</td>
<td>Linux 3.8</td>
<td>User and group IDs</td>
</tr>
<tr>
<td>CGroup</td>
<td>CLONE_NEWGROUP</td>
<td>Linux 4.6</td>
<td>Cgroup root directory</td>
</tr>
</tbody></table>
<p>And the namespaces API includes the following system calls:</p>
<ul>
<li><code>clone(...)</code>: Creates a new process. If the flags argument of the call specifies one or more of the <code>CLONE_NEW* </code> flags listed above, then new namespaces are created for each flag, and the child process is made a member of those namespaces. </li>
<li><code>setns(...)</code>: Allows the calling process to an existing namespace. </li>
<li><code>unshare(...)</code>: Allows the calling process to a new namespace.</li>
</ul>
<p>Each process has a <code>/proc/[pid]/ns/</code> subdirectory containing one entry for each namespace. All these files are linux link files with the format of  <code>namespace_type:[inode_number]</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yanhua.y@n37-144-139:~$ <span class="built_in">ls</span> -l /proc/$$/ns</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 yanhua.y yanhua.y 0 Dec 16 21:13 cgroup -&gt; <span class="string">&#x27;cgroup:[4026531835]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 yanhua.y yanhua.y 0 Dec 16 21:13 ipc -&gt; <span class="string">&#x27;ipc:[4026531839]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 yanhua.y yanhua.y 0 Dec 16 21:13 mnt -&gt; <span class="string">&#x27;mnt:[4026531840]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 yanhua.y yanhua.y 0 Dec 16 21:13 net -&gt; <span class="string">&#x27;net:[4026531992]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 yanhua.y yanhua.y 0 Dec 16 21:13 pid -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 yanhua.y yanhua.y 0 Dec 16 21:13 pid_for_children -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 yanhua.y yanhua.y 0 Dec 16 21:13 user -&gt; <span class="string">&#x27;user:[4026531837]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 yanhua.y yanhua.y 0 Dec 16 21:13 uts -&gt; <span class="string">&#x27;uts:[4026531838]&#x27;</span></span><br></pre></td></tr></table></figure>



<p>OK, that is enough, let’s back to the code.</p>
<p>If we want to <strong>isolate the hostname</strong> and specify a new hostname for the container, we can easily think of that just create a process by the <code>clone(...)</code> and pass the <code>CLONE_NEWUTS</code> flag to the function, like this:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// go run main.go run &lt;cmd&gt; &lt;args&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> os.Args[<span class="number">1</span>] &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;run&quot;</span>:</span><br><span class="line">		run()</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;child&quot;</span>:</span><br><span class="line">		child()</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;help&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Running run() %v \n&quot;</span>, os.Args[<span class="number">2</span>:])</span><br><span class="line"></span><br><span class="line">	cmd := exec.Command(<span class="string">&quot;/proc/self/exe&quot;</span>, <span class="built_in">append</span>([]<span class="type">string</span>&#123;<span class="string">&quot;child&quot;</span>&#125;, os.Args[<span class="number">2</span>:]...)...)</span><br><span class="line">	cmd.Stdin = os.Stdin</span><br><span class="line">	cmd.Stdout = os.Stdout</span><br><span class="line">	cmd.Stderr = os.Stderr</span><br><span class="line">	cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">		Cloneflags: syscall.CLONE_NEWUTS,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	must(cmd.Run())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">child</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Running child() %v \n&quot;</span>, os.Args[<span class="number">2</span>:])</span><br><span class="line"></span><br><span class="line">	cmd := exec.Command(os.Args[<span class="number">2</span>], os.Args[<span class="number">3</span>:]...)</span><br><span class="line">	cmd.Stdin = os.Stdin</span><br><span class="line">	cmd.Stdout = os.Stdout</span><br><span class="line">	cmd.Stderr = os.Stderr</span><br><span class="line"></span><br><span class="line">	must(syscall.Sethostname([]<span class="type">byte</span>(<span class="string">&quot;container&quot;</span>)))</span><br><span class="line"></span><br><span class="line">	must(cmd.Run())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">must</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There is a point we need to notice is that the <code>line 16</code> execute the <code>/proc/self/exe</code> which means the current process. By doing this, wen can <code>fork</code> the main process and pass a new argument <code>child</code> to the <code>main()</code>. In other language like <code>C/C++</code>, it may be something like <code>fork()</code> and <code>execv()</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># some tricky problem still not resolved </span></span><br><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ go run main.go run /bin/bash</span><br><span class="line">Running run() [/bin/bash] </span><br><span class="line">panic: fork/exec /proc/self/exe: operation not permitted</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># I can only do this</span></span><br><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ go build main.go </span><br><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ <span class="built_in">ls</span></span><br><span class="line">LICENSE  main  main.go	README.md</span><br><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ sudo ./main run /bin/bash</span><br><span class="line">Running run() [/bin/bash] </span><br><span class="line">Running child() [/bin/bash] </span><br><span class="line">root@container:/data00/home/yanhua.y/containers-from-scratch$ hostname </span><br><span class="line">container</span><br><span class="line">root@container:/data00/home/yanhua.y/containers-from-scratch$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ hostname </span><br><span class="line">n37-144-139</span><br></pre></td></tr></table></figure>



<p>Next is <strong>PID Isolation</strong>. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">		Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWPID,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">child</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;running child() %v as pid: %d\n&quot;</span>, os.Args[<span class="number">2</span>:], os.Getpid())</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> Similarly, we can pass the <code>CLONE_NEWPID</code> and see what happened. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ sudo ./main run /bin/bash</span><br><span class="line">Running run() [/bin/bash] </span><br><span class="line">running child() [/bin/bash] as pid: 1</span><br><span class="line">root@container:/data00/home/yanhua.y/containers-from-scratch<span class="comment"># ps</span></span><br><span class="line">    PID TTY          TIME CMD</span><br><span class="line"> 469953 pts/0    00:00:00 sudo</span><br><span class="line"> 469954 pts/0    00:00:00 main</span><br><span class="line"> 469960 pts/0    00:00:00 exe</span><br><span class="line"> 469965 pts/0    00:00:00 bash</span><br><span class="line"> 470040 pts/0    00:00:00 ps</span><br><span class="line">root@container:/data00/home/yanhua.y/containers-from-scratch<span class="comment"># echo $$</span></span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<p>Oops, something looks like went wrong!  The pid of the child container echo the <code>pid 1</code> and the current shell with <code>pid 6</code> , but when we use <code>ps</code>, <strong>it echos the process IDs of the host</strong>. </p>
<p>And the reason for that is because the <code>ps</code> command look up the <code>/proc</code> dir (actually it’s a mount pseudo-filesystem communicate with the kernel) for process information and this directory is inherited from the host, but not the same for the <code>os.GetPid()</code>. </p>
<p>Anyway the  <code>PID</code> is isolated now, what not isolated is the <strong>file system</strong>. </p>
<p>So we need to: </p>
<ol>
<li>create a new Linux file system directory, or you can download from <a target="_blank" rel="noopener" href="https://cdimage.ubuntu.com/ubuntu-base/releases/16.04.1/release/">here</a></li>
<li>change the container‘s root <code>/</code> to the new file system’s root path, and switch to it</li>
<li>and finally mount the container’s <code>proc</code></li>
</ol>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Running run() %v \n&quot;</span>, os.Args[<span class="number">2</span>:])</span><br><span class="line"></span><br><span class="line">	cmd := exec.Command(<span class="string">&quot;/proc/self/exe&quot;</span>, <span class="built_in">append</span>([]<span class="type">string</span>&#123;<span class="string">&quot;child&quot;</span>&#125;, os.Args[<span class="number">2</span>:]...)...)</span><br><span class="line">	cmd.Stdin = os.Stdin</span><br><span class="line">	cmd.Stdout = os.Stdout</span><br><span class="line">	cmd.Stderr = os.Stderr</span><br><span class="line">	cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">		Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWPID,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	must(cmd.Run())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">child</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;running child() %v as pid: %d\n&quot;</span>, os.Args[<span class="number">2</span>:], os.Getpid())</span><br><span class="line"></span><br><span class="line">	cmd := exec.Command(os.Args[<span class="number">2</span>], os.Args[<span class="number">3</span>:]...)</span><br><span class="line">	cmd.Stdin = os.Stdin</span><br><span class="line">	cmd.Stdout = os.Stdout</span><br><span class="line">	cmd.Stderr = os.Stderr</span><br><span class="line"></span><br><span class="line">	must(syscall.Sethostname([]<span class="type">byte</span>(<span class="string">&quot;container&quot;</span>)))</span><br><span class="line">	must(syscall.Chroot(<span class="string">&quot;/var/lib/ubuntu-fs&quot;</span>))  <span class="comment">//this is the path of your contaner file system to use</span></span><br><span class="line">	must(os.Chdir(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">	must(syscall.Mount(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0</span>, <span class="string">&quot;&quot;</span>)) </span><br><span class="line"></span><br><span class="line">	must(cmd.Run())</span><br><span class="line"></span><br><span class="line"><span class="comment">//	must(syscall.Unmount(&quot;proc&quot;, 0))</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At this time, it works! The <code>ps</code> echo the right content! </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ sudo ./main run /bin/bash</span><br><span class="line">Running run() [/bin/bash] </span><br><span class="line">running child() [/bin/bash] as pid: 1</span><br><span class="line">root@container:/<span class="comment"># ps</span></span><br><span class="line">    PID TTY          TIME CMD</span><br><span class="line">      1 ?        00:00:00 exe</span><br><span class="line">      6 ?        00:00:00 bash</span><br><span class="line">     11 ?        00:00:00 ps</span><br><span class="line">root@container:/<span class="comment"># ls proc</span></span><br><span class="line">1              bus       diskstats        fs          key-users    locks    pagetypeinfo  softirqs       timer_list</span><br><span class="line">13             cgroups   dma              interrupts  keys         meminfo  partitions    <span class="built_in">stat</span>           <span class="built_in">tty</span></span><br><span class="line">6              cmdline   driver           iomem       kmsg         misc     pressure      swaps          <span class="built_in">uptime</span></span><br><span class="line">acpi           consoles  elkeid-endpoint  ioports     kpagecgroup  modules  sched_debug   sys            version</span><br><span class="line">asound         cpuinfo   execdomains      irq         kpagecount   mounts   schedstat     sysrq-trigger  vmallocinfo</span><br><span class="line">bpf_unsafe_gh  crypto    fb               kallsyms    kpageflags   mtrr     self          sysvipc        vmstat</span><br><span class="line">buddyinfo      devices   filesystems      kcore       loadavg      net      slabinfo      thread-self    zoneinfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@container:/<span class="comment"># mount</span></span><br><span class="line">proc on /proc <span class="built_in">type</span> proc (rw,relatime)</span><br><span class="line">root@container:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ mount</span><br><span class="line"><span class="comment">#...</span></span><br><span class="line">proc on /var/lib/ubuntu-fs/proc <span class="built_in">type</span> proc (rw,relatime)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>Next is <strong>mount isolation</strong>. </p>
<p>As you can notice the last several lines, the <strong>mount info of the container can be seen in the host</strong> which we would not want.</p>
<p>Naturally we put the <code>CLONE_NEWNS</code> to the <code>clone(...)</code>  and see what happen.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// codes...</span></span><br><span class="line">cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">		Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS, </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// codes..</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ sudo ./main run /bin/bash</span><br><span class="line">Running run() [/bin/bash] </span><br><span class="line">running child() [/bin/bash] as pid: 1</span><br><span class="line">root@container:/<span class="comment"># mount</span></span><br><span class="line">proc on /proc <span class="built_in">type</span> proc (rw,relatime)</span><br><span class="line">root@container:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ mount</span><br><span class="line"><span class="comment">#...</span></span><br><span class="line">proc on /var/lib/ubuntu-fs/proc <span class="built_in">type</span> proc (rw,relatime)</span><br></pre></td></tr></table></figure>

<p><strong>Nothing changed !</strong> This is because the mount isolation have a special setting of <code>propagation type</code> , the default is <code>MS_SHARED</code> which means the mount action propagate between host and container. If we want break this rule, we can set the <code>propagation type</code> to <code>MS_SLAVE</code>. In Go, we can add the <code>CLONE_NEWNS</code>  to the <code>SysProcAttr.Unshareflags</code>.  And finnally it works</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</span><br><span class="line">	Cloneflags:   syscall.CLONE_NEWUTS | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS,</span><br><span class="line">	Unshareflags: syscall.CLONE_NEWNS,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ sudo ./main run /bin/bash</span><br><span class="line">Running run() [/bin/bash] </span><br><span class="line">running child() [/bin/bash] as pid: 1</span><br><span class="line">root@container:/<span class="comment"># mount</span></span><br><span class="line">proc on /proc <span class="built_in">type</span> proc (rw,relatime)</span><br><span class="line">root@container:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ mount |grep proc</span><br><span class="line">proc on /proc <span class="built_in">type</span> proc (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line"><span class="comment"># no proc mount on /var/lib/ubuntu-fs</span></span><br></pre></td></tr></table></figure>

<p>The rest of namespace isolation is similar and won’t be covered here.</p>
<h1 id="CGroups-Availability"><a href="#CGroups-Availability" class="headerlink" title="CGroups: Availability"></a>CGroups: Availability</h1><p>The namespaces controls the visibility of the container. Now we’ll solve how to control the <strong>availability of resource</strong>.</p>
<p>As before, let’s get some basic prior knowledge of the <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/cgroups.7.html">CGroups</a> in the Linux OS.</p>
<p>CGroups are a Linux kernel feature which allow processes to be organized into hierarchical groups whose usage of various types of resources can then be <strong>limited and monitored</strong>.  The kernel’s cgroup interface is provided through a pseudo-filesystem called <code>cgroupfs</code> (same as <code>/proc</code>). All of the cgroups files are maintained in the path <code>/sys/fs/cgroup</code> .</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup$ <span class="built_in">ls</span></span><br><span class="line">blkio  cpuacct	    cpuset   freezer  net_cls		net_prio    pids     unified</span><br><span class="line">cpu    cpu,cpuacct  devices  memory   net_cls,net_prio	perf_event  systemd</span><br><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup$ <span class="built_in">cd</span> memory/</span><br><span class="line"></span><br><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup/memory$ <span class="built_in">ls</span></span><br><span class="line">cgroup.clone_children	    memory.kmem.max_usage_in_bytes	memory.memsw.limit_in_bytes	 memory.usage_in_bytes</span><br><span class="line">cgroup.event_control	    memory.kmem.slabinfo		memory.memsw.max_usage_in_bytes  memory.use_hierarchy</span><br><span class="line">cgroup.procs		    memory.kmem.tcp.failcnt		memory.memsw.usage_in_bytes	 memory.watermark</span><br><span class="line">cgroup.sane_behavior	    memory.kmem.tcp.limit_in_bytes	memory.move_charge_at_immigrate  memory.watermark_scale_factor</span><br><span class="line">etrace_cpu		    memory.kmem.tcp.max_usage_in_bytes	memory.numa_stat		 notify_on_release</span><br><span class="line">etrace_mem		    memory.kmem.tcp.usage_in_bytes	memory.oom_control		 release_agent</span><br><span class="line">memory.failcnt		    memory.kmem.usage_in_bytes		memory.pressure_level		 system.slice</span><br><span class="line">memory.force_empty	    memory.limit_in_bytes		memory.soft_limit_in_bytes	 tao_tasks</span><br><span class="line">memory.kmem.failcnt	    memory.max_usage_in_bytes		memory.stat			 tasks</span><br><span class="line">memory.kmem.limit_in_bytes  memory.memsw.failcnt		memory.swappiness		 user.slice</span><br></pre></td></tr></table></figure>

<p>Here is the Go code. We call <code>cg()</code> <strong>before</strong> the <code>Chroot()</code> function. The <code>cg()</code> function first create a cgroup dir  for the container, and then  limit the max process num to <code>20</code>, in the end add the child process to the cgroup by add its pid into the <code>cgroup.proc</code> file.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">child</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Running %v \n&quot;</span>, os.Args[<span class="number">2</span>:])</span><br><span class="line"></span><br><span class="line">	cg()</span><br><span class="line">  </span><br><span class="line">	cmd := exec.Command(os.Args[<span class="number">2</span>], os.Args[<span class="number">3</span>:]...)</span><br><span class="line">	....</span><br><span class="line">  </span><br><span class="line">	must(cmd.Run())</span><br><span class="line">	must(syscall.Unmount(<span class="string">&quot;proc&quot;</span>, <span class="number">0</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cg</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// Create a cgroup dir for the container</span></span><br><span class="line">	cgroups := <span class="string">&quot;/sys/fs/cgroup/&quot;</span></span><br><span class="line">	pids := filepath.Join(cgroups, <span class="string">&quot;pids&quot;</span>)</span><br><span class="line">	os.Mkdir(filepath.Join(pids, <span class="string">&quot;liz&quot;</span>), <span class="number">0755</span>)</span><br><span class="line">  </span><br><span class="line">	must(ioutil.WriteFile(filepath.Join(pids, <span class="string">&quot;liz/pids.max&quot;</span>), []<span class="type">byte</span>(<span class="string">&quot;20&quot;</span>), <span class="number">0700</span>))</span><br><span class="line">	<span class="comment">// Removes the new cgroup in place after the container exits</span></span><br><span class="line">	must(ioutil.WriteFile(filepath.Join(pids, <span class="string">&quot;liz/notify_on_release&quot;</span>), []<span class="type">byte</span>(<span class="string">&quot;1&quot;</span>), <span class="number">0700</span>))</span><br><span class="line">  <span class="comment">// Write the pid into the cgroup.procs means add this process to the cgroup</span></span><br><span class="line">	must(ioutil.WriteFile(filepath.Join(pids, <span class="string">&quot;liz/cgroup.procs&quot;</span>), []<span class="type">byte</span>(strconv.Itoa(os.Getpid())), <span class="number">0700</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Below is a tricky way to check the container process is in the cgroup.  In the container process call <code>sleep</code>, find the pid in the host, check the pid in the new cgroups dir’s <code>cgroup.procs</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># container bash ...</span></span><br><span class="line">yanhua.y@n37-144-139:~/containers-from-scratch$ sudo ./main run /bin/bash</span><br><span class="line">running child() [/bin/bash] as pid: 643812</span><br><span class="line">running child() [/bin/bash] as pid: 1</span><br><span class="line">root@container:/<span class="comment"># sleep 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># host bash ...</span></span><br><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup/pids/liz$ <span class="built_in">cat</span> pids.max</span><br><span class="line">20</span><br><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup/pids/liz$ <span class="built_in">cat</span> cgroup.procs </span><br><span class="line">643817</span><br><span class="line">643822</span><br><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup/pids/liz$ ps -C <span class="built_in">sleep</span></span><br><span class="line">    PID TTY          TIME CMD</span><br><span class="line"> 644805 ?        00:00:00 <span class="built_in">sleep</span></span><br><span class="line"> 644817 pts/0    00:00:00 <span class="built_in">sleep</span></span><br><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup/pids/liz$ <span class="built_in">cat</span> cgroup.procs </span><br><span class="line">643817</span><br><span class="line">643822</span><br><span class="line">644817</span><br></pre></td></tr></table></figure>

<p>At last, we can check the limit of pid amount works. We run the <code>:() &#123; : | : &amp; &#125; ; :</code>  which keeps fork child without break. </p>
<p>Everything goes well, the host isn’t crash and the total number of process is limited to <code>20</code>.</p>
<p>Similarly, other resource listed in the <code>/sys/fs/cgroup</code> can also be controlled by this way. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># container bash</span></span><br><span class="line">root@container:/<span class="comment"># :() &#123; : | : &amp; &#125; ; :</span></span><br><span class="line">[1] 15</span><br><span class="line">root@container:/<span class="comment"># bash: fork: retry: Resource temporarily unavailable</span></span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: Resource temporarily unavailable</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: Resource temporarily unavailable</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line">bash: fork: retry: No child processes</span><br><span class="line"></span><br><span class="line"><span class="comment"># host bash</span></span><br><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup/pids/liz$ <span class="built_in">cat</span> pids.current </span><br><span class="line">20</span><br><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup/pids/liz$ <span class="built_in">cat</span> cgroup.procs </span><br><span class="line">643817</span><br><span class="line">643822</span><br><span class="line">yanhua.y@n37-144-139:/sys/fs/cgroup/pids/liz$ ps fa</span><br><span class="line">    PID TTY      STAT   TIME COMMAND</span><br><span class="line"> 641238 pts/1    Ss     0:00 -bash</span><br><span class="line"> 645972 pts/1    R+     0:00  \_ ps fa</span><br><span class="line"> 637779 pts/0    Ss     0:00 -bash</span><br><span class="line"> 643811 pts/0    S      0:00  \_ sudo ./main run /bin/bash</span><br><span class="line"> 643812 pts/0    Sl     0:00      \_ ./main run /bin/bash</span><br><span class="line"> 643817 pts/0    Sl     0:00          \_ /proc/self/exe child /bin/bash</span><br><span class="line"> 643822 pts/0    S+     0:00              \_ /bin/bash</span><br><span class="line"> 645470 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645471 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645472 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645473 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645474 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645475 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645476 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645477 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645478 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645479 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645480 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645481 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645482 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line"> 645483 pts/0    Z      0:00              \_ [bash] &lt;defunct&gt;</span><br><span class="line">   1174 ttyS0    Ss+    0:00 /sbin/agetty -o -p -- \u --keep-baud 115200,38400,9600 ttyS0 vt220</span><br><span class="line">   1172 tty1     Ss+    0:00 /sbin/agetty -o -p -- \u --noclear tty1 linux</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I believe that through the above introduction, you must get deeper into Docker, as least for me. </p>
<p>Let’s back to a classic question: What is Docker or Container?</p>
<p>From this post, we can feel that a container is a capsulate of a process’s environment that isolate from the host machine and other containers. This definition is not accurately but can help you to understand what this post is doing. </p>
<p>Last is the comparison of Docker and Virtual Machine. As we know, an operating system is is divided into two parts: Kernel and Application(Run Time Library). The most difference between the Docker and the Virtual Machine is the isolation level. The Virtual Machine Virtualized a totally new Guest Operating System without using the host’s kernel, but the docker just virtualized a new application level engine and all containers shared the same host kernel.</p>
<img src="http://images.ashery.cn/img/639df1d7b1fccdcd3608a069.jpg" alt="docker-vs-container" style="zoom: 50%;" />





</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.ashery.cn">Asher Yan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.ashery.cn/posts/6cc923ae.html">https://blog.ashery.cn/posts/6cc923ae.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.ashery.cn" target="_blank">Asher Yan's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/docker/">docker</a><a class="post-meta__tags" href="/tags/go/">go</a><a class="post-meta__tags" href="/tags/linux/">linux</a></div><div class="post_share"><div class="social-share" data-image="http://images.ashery.cn/img/639debd8b1fccdcd36fe1b3d.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/394c83b4.html"><img class="prev-cover" src="http://images.ashery.cn/img/63aec3ee08b683016379e600.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Docker基本介绍</div></div></a></div><div class="next-post pull-right"><a href="/posts/ce42447b.html"><img class="next-cover" src="https://images.ashery.cn/img/pexels-cody-king-1208074.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">《见识》读书笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/394c83b4.html" title="Docker基本介绍"><img class="cover" src="http://images.ashery.cn/img/63aec3ee08b683016379e600.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-28</div><div class="title">Docker基本介绍</div></div></a></div><div><a href="/posts/8c5a54e3.html" title="Go 垃圾回收介绍"><img class="cover" src="http://images.ashery.cn/img/P1100340.JPG" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-12</div><div class="title">Go 垃圾回收介绍</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://images.ashery.cn/img/202304202309024.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Asher Yan</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/YHsilver"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Background"><span class="toc-number">1.</span> <span class="toc-text">Background</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Namespace-Visibility"><span class="toc-number">2.</span> <span class="toc-text">Namespace: Visibility</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CGroups-Availability"><span class="toc-number">3.</span> <span class="toc-text">CGroups: Availability</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/5612ed5e.html" title="工作与生活的思考"><img src="http://images.ashery.cn/img/P1375432.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="工作与生活的思考"/></a><div class="content"><a class="title" href="/posts/5612ed5e.html" title="工作与生活的思考">工作与生活的思考</a><time datetime="2023-09-10T03:16:13.000Z" title="发表于 2023-09-10 11:16:13">2023-09-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/6918edaf.html" title="ChatGPT的X种用途"><img src="http://images.ashery.cn/img/image-20230406210518731.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ChatGPT的X种用途"/></a><div class="content"><a class="title" href="/posts/6918edaf.html" title="ChatGPT的X种用途">ChatGPT的X种用途</a><time datetime="2023-03-20T07:06:59.000Z" title="发表于 2023-03-20 15:06:59">2023-03-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8c5a54e3.html" title="Go 垃圾回收介绍"><img src="http://images.ashery.cn/img/P1100340.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Go 垃圾回收介绍"/></a><div class="content"><a class="title" href="/posts/8c5a54e3.html" title="Go 垃圾回收介绍">Go 垃圾回收介绍</a><time datetime="2023-03-12T07:07:10.000Z" title="发表于 2023-03-12 15:07:10">2023-03-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/80b7b4ba.html" title="hacker &amp; painter"><img src="http://images.ashery.cn/img/61MSZsYP-NL.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="hacker &amp; painter"/></a><div class="content"><a class="title" href="/posts/80b7b4ba.html" title="hacker &amp; painter">hacker &amp; painter</a><time datetime="2023-03-12T07:06:45.000Z" title="发表于 2023-03-12 15:06:45">2023-03-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/52b98882.html" title="Kubernetes 基本介绍"><img src="http://images.ashery.cn/img/DSC01653%20(2).JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes 基本介绍"/></a><div class="content"><a class="title" href="/posts/52b98882.html" title="Kubernetes 基本介绍">Kubernetes 基本介绍</a><time datetime="2023-02-04T11:34:20.000Z" title="发表于 2023-02-04 19:34:20">2023-02-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Asher Yan</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>